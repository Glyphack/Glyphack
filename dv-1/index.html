<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https:/glyphack.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https:/glyphack.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https:/glyphack.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https:/glyphack.com/android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https:/glyphack.com/apple-touch-icon.png><meta name=description content><title>Devlog 0001: Contributing to Ruff, Profiling, Python Types Conformance Tests | Glyphack</title><link rel=canonical href=https://glyphack.com/dv-1/><meta property="og:url" content="https://glyphack.com/dv-1/"><meta property="og:site_name" content="Glyphack"><meta property="og:title" content="Devlog 0001: Contributing to Ruff, Profiling, Python Types Conformance Tests"><meta property="og:description" content="Last week I wanted to start contributing to rust. I was working on Adding uninitialized attribute access check to Ruff.
I did it and learned a lot about how to track attributes in Python code. A gist of it would be, you need to go over the class, in each function when something is assigned to a name you need to check if that name is self or cls. And you do this by checking if it matches the first argument of that function. Then if the function is a class method it’s cls and otherwise self."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-02-03T10:56:48+01:00"><meta property="article:modified_time" content="2024-02-03T10:56:48+01:00"><meta property="article:tag" content="Devlog"><link rel=stylesheet href=/assets/combined.min.455b53327434f234e64209735e8469bb37465ce15a3ebc45a1a586dd5e74c673.css media=all><script async defer data-website-id=e8710f0c-a6f2-4d2d-8b95-ef6b66e72226 src=https://cloud.umami.is/script.js></script></head><body class=light><div class=content><header><div class=header><h1 class=header-title><a href=https://glyphack.com/>Glyphack</a></h1><div class=flex><p class=small><a href=/>/Home</a></p><p class=small><a href=/blog/>/Blog</a></p><p class=small><a href=/projects/>/Projects</a></p><p class=small><a href=/now/>/Now</a></p><p class=small><a href=/reading-list/>/Reading List</a></p><p class=small><a href=https://r.glyphack.com/s/s>/Reads This</a></p><p class=small><a href="https://docs.google.com/document/d/1XgC2Va8ZgJ2DrmRKpgd_7iVjv8aASnn8nzl6DgkR1mg/edit?usp=sharing">/Resume</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a><span class=breadcrumbs-separator>/</span><a href=/blog/>Blog</a><span class=breadcrumbs-separator>/</span>
<a href=/dv-1/>Devlog 0001: Contributing to Ruff, Profiling, Python Types Conformance Tests</a></div><div><article><header class=single-intro-container><h1 class=single-title>Devlog 0001: Contributing to Ruff, Profiling, Python Types Conformance Tests</h1><p class=single-readtime><time datetime=2024-02-03T10:56:48+01:00>February 3, 2024</time></p></header><div class=single-content><p>Last week I wanted to start contributing to rust.
I was working on Adding <a href=https://github.com/astral-sh/ruff/pull/9513>uninitialized attribute access check</a> to Ruff.</p><p>I did it and learned a lot about how to track attributes in Python code.
A gist of it would be, you need to go over the class, in each function when something is assigned to a name you need to check if that name is self or cls.
And you do this by checking if it matches the first argument of that function.
Then if the function is a class method it&rsquo;s cls and otherwise self.</p><p>I also learned about profiling.
After finishing the implementation I realized the benchmarks are failing.
So I need see how did I mess up the performance. It is not because of the rule but because of the code I added to the visitor to keep track of attribute initialization and access.
But first we need to profile.</p><p>I found two resources for doing it.
Maybe I can do a separate note on Rust profiling.
<a href=https://nnethercote.github.io/perf-book/>Rust Performance Book</a> which has a profiling section.
<a href=https://docs.astral.sh/ruff/contributing/#profiling-projects>Amazing guide for Ruff Only</a></p><p>The interesting part is that Macos is not good for profiling, or at least I could not easily learn to use the tools.
I used cargo instruments, the output can be opened with instruments app. Instruments app is dog shit.
I expected some kind of home page, documentation or something when I search for it like <a href=https://jetbrains.com/help/idea/profiler-intro.html>this</a>.
But nothing.</p><p>So I could not find traces for the functions I added(skill issue.) I gave up.</p><p>In the end I ended up using <a href=https://github.com/mstange/samply>Samply</a> which was better.</p><p>I also used the cargo benchmark and <a href=https://github.com/BurntSushi/critcmp>critcmp</a> to compare results between my commits and found the perf issue.</p><p>It was caused because I added a new vector to each scope to keep track of undefined attribute accesses.
But I realized I can just have a global vector for the whole file and store the undefined attribute along with it&rsquo;s scope.</p><p>With a vector on every scope and many allocations:</p><pre tabindex=0><code>linter/default-rules/large/dataset.py       1.00    455.7±6.28µs    89.3 MB/sec    1.14   519.6±19.69µs    78.3 MB/sec
linter/default-rules/numpy/ctypeslib.py     1.00     86.9±1.62µs   191.5 MB/sec    1.14     99.3±6.53µs   167.8 MB/sec
linter/default-rules/numpy/globals.py       1.00     12.5±0.19µs   236.4 MB/sec    1.05     13.1±0.10µs   225.1 MB/sec
linter/default-rules/pydantic/types.py      1.00    194.5±4.85µs   131.2 MB/sec    1.16   226.3±42.70µs   112.7 MB/sec
linter/default-rules/unicode/pypinyin.py    1.00     31.7±0.29µs   132.6 MB/sec    1.06     33.7±1.64µs   124.7 MB/sec
</code></pre><p>After using a global vector for the whole program:</p><pre tabindex=0><code>linter/default-rules/large/dataset.py       1.00    455.7±6.28µs    89.3 MB/sec    1.03    469.9±5.46µs    86.6 MB/sec
linter/default-rules/numpy/ctypeslib.py     1.00     86.9±1.62µs   191.5 MB/sec    1.02     88.8±1.47µs   187.6 MB/sec
linter/default-rules/numpy/globals.py       1.00     12.5±0.19µs   236.4 MB/sec    1.04     13.0±0.10µs   227.1 MB/sec
linter/default-rules/pydantic/types.py      1.00    194.5±4.85µs   131.2 MB/sec    1.03    201.2±4.70µs   126.8 MB/sec
linter/default-rules/unicode/pypinyin.py    1.00     31.7±0.29µs   132.6 MB/sec    1.03     32.7±0.28µs   128.7 MB/sec
</code></pre><p>I also learned that codespeed is a wonderful tool for exploring performance changes between my commits.
<a href=https://codspeed.io/astral-sh/ruff/branches/Glyphack:linter-pylint-E0203>Example</a>, next time I use this.</p><p>For enderpy I was looking for a test suite that I can develop against until my type checker is complete.
Luckily it exists! You can view it <a href=https://github.com/python/typing/tree/main/conformance>here</a>.
It does not have a basic test case were you only have functions and variables but that one is easy to come up with myself.</p></div></article><div class=single-pagination><hr><div class=flexnowrap><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/five-thousands-lines-of-kotlin/>Five Thousands Lines of Kotlin</a></div></div></div><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text><a href=/rewrite/>Don't be afraid to Rewrite</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>Powered by
<a href=https://gohugo.io/>Hugo</a>
and
<a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer></body><script src=/js/theme-switch.js></script><script defer src=/js/copy-code.js></script></html>